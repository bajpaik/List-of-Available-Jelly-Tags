/***********UI PAGE************/
//HTML
<?xml version="1.0" encoding="utf-8" ?>
<j:jelly xmlns:j="jelly:core" xmlns:g="glide" xmlns:j2="null" xmlns:g2="null">
    <g2:ui_form id="transfer_case_dialog">
	<input id="selected-queue" type="hidden" value="${JS,HTML:queue}"></input>
	<input id="selected-reason" type="hidden" value="${JS,HTML:reason}"></input>
               <!-- Define UI elements within the form -->
        <div style="margin-bottom: 2px;">
            <div class="col-md-12 queue">
                <p style="font-size: 15px;">${gs.getMessage("Select Queue")}</p>
                <g2:ui_reference name="location_queue" id="location_queue" table="wu_location_queue" completer="AJAXTableCompleter" query="active=true" onchange="showReasons(this)"/>
            </div>
        </div>
        
        <div style="margin-bottom: 2px;">
            <div class="col-md-12 queue-reasons">
                <p style="font-size: 15px;">${gs.getMessage("Select Reason")}</p>
                <g2:ui_reference name="reason_reference" id="reason_reference" 
				table="wu_reason" completer="AJAXTableCompleter"/>
            </div>
        </div>
       
        <div id="dialog_buttons" class="clearfix pull-right" style="margin-top:20px">
            <button type="button" class="btn btn-primary disabled" aria-disabled="true" id="route-button" onclick="routeInteraction()" title="${gs.getMessage('Transfer details to new interaction')}">${gs.getMessage('Transfer')}</button>
        </div>

    </g2:ui_form>
</j:jelly>

//CLIENT SCRIPT
function showReasons(element) {
    var queueReferenceField = element.value;
    gel('selected-queue').value = queueReferenceField;
    if (queueReferenceField) {
        var ga = new GlideAjax('sn_walkup.LTU_WalkUpUtilClient');
        ga.addParam('sysparm_name', 'getQueueReasons');
        ga.addParam('sysparm_queueId', queueReferenceField);
        ga.getXMLAnswer(function(answer) {
            if (answer) {
                var reasonRefBtn = gel('lookup.reason_reference');

                reasonRefBtn.setAttribute('onclick', "mousePositionSave(event);reflistOpen( 'reason_reference', 'not', gel('reason_referenceTABLE').value, '', 'false', 'QUERY:" + answer + "','" + answer + "','')");
                var locationReferenceField = gel('selected-queue');
                queueReferenceField.value = answer;
            }

        });
    }
}

function setReason(elem) {
    var reasonReferenceField = elem.value;
    gel('selected-reason').value = reasonReferenceField;
    //Enable transfer button
    if (reasonReferenceField && gel('selected-queue').value) {
        var trnsBtn = gel('route-button');
        trnsBtn.classList.remove("disabled");
    }
}

function routeInteraction() {
    var sys_id = '',
        urlPath = top.location.pathname,
        view;

    if (top.location.pathname.indexOf('/now/sow/') > -1) {
        var parts = urlPath.split('/record/interaction/');
        sys_id = parts[1].split('/')[0];
        view = 'workspace';
    } else {
        sys_id = g_form.getUniqueValue();
        view = 'native';
    }
    var fields = {
        'selected_queue': gel('selected-queue').value,
        'selected_reason': gel('selected-reason').value,
        'record_sys_id': sys_id
    };
    var util = new GlideAjax('sn_walkup.LTU_WalkUpUtilClient');
    util.addParam('sysparm_name', 'transferInteraction');
    util.addParam('sysparm_fields', JSON.stringify(fields));
    util.getXMLAnswer(function(response) {
        if (response != '') {
            if (view != 'workspace')
                GlideDialogWindow.get().destroy();
            reloadWindow(window);
        }
    });
}
